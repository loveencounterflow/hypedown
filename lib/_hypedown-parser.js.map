{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/_hypedown-parser.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n\n'use strict'\n\n\n############################################################################################################\nGUY                       = require 'guy'\n{ alert\n  debug\n  help\n  info\n  plain\n  praise\n  urge\n  warn\n  whisper }               = GUY.trm.get_loggers 'HYPEDOWN-PARSER'\n#...........................................................................................................\n{ rpr\n  inspect\n  echo\n  log     }               = GUY.trm\n#...........................................................................................................\n{ DATOM }                 = require 'datom'\n#...........................................................................................................\n{ new_datom\n  lets\n  stamp }                = DATOM\n#...........................................................................................................\n{ Pipeline\n  $\n  transforms }            = require 'moonriver'\n#...........................................................................................................\n{ misfit\n  get_base_types }        = require './types'\nE                         = require './errors'\nH                         = require './helpers'\n{ Hypedown_parser_stars } = require './_hypedown-parser-stars'\n{ Hypedown_parser_htmlish } \\\n                          = require './_hypedown-parser-htmlish'\n{ Hypedown_lexer }        = require './_hypedown-lexer'\n\n\n#-----------------------------------------------------------------------------------------------------------\nselect_token = ( token, selector ) ->\n  return false unless token?\n  return false if token.$stamped ? false\n  return token.mk is selector\n\n\n\n\n#===========================================================================================================\nclass Hypedown_transforms extends \\\n  Hypedown_parser_stars \\\n  Hypedown_parser_htmlish()\n\n\n  #=========================================================================================================\n  # PREPARATION\n  #---------------------------------------------------------------------------------------------------------\n  $inject_virtual_nl: ->\n    ### normalize start of document by injecting two newlines. ###\n    is_first  = true\n    mode      = 'plain'\n    tid       = 'nl'\n    mk        = \"#{mode}:#{tid}\"\n    return ( d, send ) ->\n      return send d unless is_first\n      is_first = false\n      send { mode, tid, mk, jump: null, value: '', lnr1: 1, x1: 0, lnr2: 1, x2: 0, \\\n        atrs: { virtual: true, }, $key: '^plain', $: 'inject_virtual_nl', }\n      send { mode, tid, mk, jump: null, value: '', lnr1: 1, x1: 0, lnr2: 1, x2: 0, \\\n        atrs: { virtual: true, }, $key: '^plain', $: 'inject_virtual_nl', }\n      send d\n\n  #---------------------------------------------------------------------------------------------------------\n  $add_parbreak_markers: -> ### needs inject_virtual_nl ###\n    mode        = 'plain'\n    newline_lx  = \"#{mode}:nl\"\n    tid         = 'parbreak'\n    mk          = \"html:#{tid}\"\n    p           = new Pipeline()\n    template    = { \\\n        mode: 'html', tid, mk, value: '', \\\n        $key: '^html', $: 'add_parbreak_markers', }\n    p.push window = transforms.$window { min: -2, max: 0, empty: null, }\n    p.push add_parbreak_markers = ( [ lookbehind, previous, current, ], send ) ->\n      return send current unless ( select_token lookbehind,  newline_lx )\n      return send current unless ( select_token previous,    newline_lx )\n      return send current if     ( select_token current,     newline_lx )\n      send { template..., ( GUY.props.pick_with_fallback current, null, 'lnr1', 'x1', 'lnr2', 'x2', )..., }\n      send current\n    return p\n\n\n  #=========================================================================================================\n  # PREPARATION\n  #---------------------------------------------------------------------------------------------------------\n  $parse_md_codespan: ({ outer_mode, enter_tid, inner_mode, exit_tid }) ->\n    ### TAINT consider to rewrite using `$window()` transform ###\n    ### TAINT use CFG pattern ###\n    ### TAINT use API for `mode:key` IDs ###\n    enter_mk  = \"#{outer_mode}:#{enter_tid}\"\n    exit_mk   = \"#{inner_mode}:#{exit_tid}\"\n    text_mk   = \"#{inner_mode}:text\"\n    escchr_mk = \"#{inner_mode}:escchr\"\n    collector = []\n    #.......................................................................................................\n    flush = ->\n      last_idx      = collector.length - 1\n      first_txt_idx = 1\n      last_txt_idx  = last_idx - 1\n      lnr1          = ( collector.at  0 ).lnr1\n      lnr2          = ( collector.at -1 ).lnr2\n      x1            = ( collector.at  0 ).x1\n      x2            = ( collector.at -1 ).x2\n      texts         = []\n      #.....................................................................................................\n      for d, idx in collector\n        if ( idx is 0 )\n          yield stamp d\n          yield H.XXX_new_token 'parse_md_codespan', d, 'html', 'tag', 'code', '<code>'\n          continue\n        else if ( idx is last_idx )\n          yield stamp d\n          yield H.XXX_new_token 'parse_md_codespan', d, 'html', 'tag', 'code', '</code>'\n          continue\n        #...................................................................................................\n        switch d.mk\n          when text_mk\n            if      idx is first_txt_idx  then  texts.push d.value.trimStart()\n            else if idx is last_txt_idx   then  texts.push d.value.trimEnd()\n            else                                texts.push d.value\n          when escchr_mk\n            ### TAINT must properly resolve escaped character ###\n            texts.push d.x.chr\n          else\n            throw new Error \"^^parse_md_codespan@32\", \"internal error: unhandled token #{rpr d}\"\n        #...................................................................................................\n        if ( idx is last_txt_idx )\n          value = texts.join ''\n          ### TAINT should not use `html` or must escape first ###\n          yield { mode: 'html', tid: 'text', mk: 'html:text', value, lnr1, x1, lnr2, x2, }\n      #.....................................................................................................\n      collector.length = 0\n      return null\n    #.......................................................................................................\n    return ( d, send ) ->\n      switch d.mk\n        when enter_mk, text_mk, escchr_mk\n          collector.push d\n        when exit_mk\n          collector.push d\n          send d for d from flush()\n        else\n          send d\n          # send H.XXX_new_token 'parse_md_codespan', d, 'html', 'text', null, d.value\n      return null\n\n  #---------------------------------------------------------------------------------------------------------\n  $parse_md_hashes: ({ mode, tid, }) ->\n    mode         ?= 'plain'\n    tid          ?= 'hashes'\n    hashes_mk     = \"#{mode}:#{tid}\"\n    prv_was_empty = false\n    return ( d, send ) ->\n      return send d unless d.mk is hashes_mk\n      send stamp d\n      name = \"h#{d.x.text.length}\"\n      send H.XXX_new_token 'parse_md_hashes', d, 'html', 'tag', name, \"<#{name}>\"\n      return null\n\n\n  #=========================================================================================================\n  # FINALIZATION\n  #---------------------------------------------------------------------------------------------------------\n  $capture_text: ->\n    catchall_lx = \"plain:other\"\n    return ( d, send ) ->\n      return send d unless select_token d, catchall_lx\n      send stamp d\n      send H.XXX_new_token 'capture_text', d, 'html', 'text', d.value, d.value\n\n  #---------------------------------------------------------------------------------------------------------\n  $generate_missing_p_tags: -> ### needs add_parbreak_markers, capture_text ###\n    ### NOTE\n\n    * https://stackoverflow.com/questions/8460993/p-end-tag-p-is-not-needed-in-html\n\n    For the time being we opt for *not* using closing `</p>` tags, the reason for this being that they are\n    not required by HTML5, and it *may* (just may) make things easier down the line when the closing tag is\n    made implicit. However, observe that the very similar `<div>` tag still has to be closed explicitly.\n\n    ###\n    parbreak_lx   = \"html:parbreak\"\n    html_text_lx  = \"html:text\"\n    p             = new Pipeline()\n    p.push window = transforms.$window { min: -1, max: +1, empty: null, }\n    p.push generate_missing_p_tags = ( [ prv, d, nxt, ], send ) ->\n      ### TAINT not a correct solution, paragraph could begin with an inline element, so better check for\n      nxt being namespace `html`, followed by any content category of `<p>` (i.e. Phrasing Content)\n\n      see https://developer.mozilla.org/en-US/docs/Web/HTML/Element/p?retiredLocale=de,\n      https://developer.mozilla.org/en-US/docs/Web/HTML/Content_categories#phrasing_content ###\n      return send d unless select_token prv,  parbreak_lx\n      # return send d unless select_token nxt,  html_text_lx\n      send H.XXX_new_token 'generate_missing_p_tags', d, 'html', 'text', '<p>', '<p>'\n      send d\n    return p\n\n  #---------------------------------------------------------------------------------------------------------\n  $generate_html_nls: -> ### needs generate_missing_p_tags ###\n    newline_lx = \"plain:nl\"\n    return generate_html_nls = ( d, send ) ->\n      return send d unless select_token d, newline_lx\n      send stamp d\n      return if d.atrs?.virtual ? false\n      send H.XXX_new_token 'generate_html_nls', d, 'html', 'text', '\\n', '\\n'\n    return p\n\n  #---------------------------------------------------------------------------------------------------------\n  $convert_escaped_chrs: ->\n    ### TAINT prelimary ###\n    ### TAINT must escape for HTML, so `\\<` becomes `&lt;` and so on ###\n    ### TAINT must consult registry of escape codes so `\\n` -> U+000a but `\\a` -> U+0061 ###\n    escchr_tid = 'escchr'\n    return ( d, send ) ->\n      return send d unless d.tid is escchr_tid\n      send stamp d\n      send H.XXX_new_token 'convert_escaped_chrs', d, d.mode, 'text', d.x.chr, d.x.chr\n      # send H.XXX_new_token 'convert_escaped_chrs', d, 'html', 'text', d.x.chr, d.x.chr\n\n  #---------------------------------------------------------------------------------------------------------\n  $stamp_borders: -> ( d, send ) -> send if d.tid is '$border' then ( stamp d ) else d\n\n\n#===========================================================================================================\nclass Hypedown_parser\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    @types        = get_base_types()\n    @cfg          = Object.freeze @types.create.hd_parser_cfg cfg\n    @lexer        = new Hypedown_lexer()\n    # debug '^234^', @lexer\n    @_build_pipeline()\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  _build_pipeline: ->\n    tfs       = new Hypedown_transforms()\n    @pipeline = new Pipeline()\n    #.........................................................................................................\n    # @pipeline.push ( d ) -> urge '^_build_pipeline@1^', rpr d\n    @pipeline.push tokenize_line = ( line, send ) =>\n      # info '^_build_pipeline@2^', rpr line\n      # info '^_build_pipeline@3^', ( t for t from @lexer.walk line )\n      @types.validate.text line\n      send token for token from @lexer.walk line\n      return null\n    # @pipeline.push ( d ) -> urge '^_build_pipeline@4^', rpr d\n    @pipeline.push tfs.$inject_virtual_nl()\n    @pipeline.push tfs.$add_parbreak_markers()\n    # @pipeline.push ( d ) -> urge '^965-1^', d\n    @pipeline.push tfs.$parse_htmlish()\n    @pipeline.push tfs.$parse_md_stars()\n    @pipeline.push tfs.$parse_md_hashes { mode: 'plain', tid: 'hashes', }\n    @pipeline.push tfs.$parse_md_codespan { outer_mode: 'plain', enter_tid: 'codespan', inner_mode: 'cspan', exit_tid: 'codespan', }\n    @pipeline.push tfs.$capture_text()\n    @pipeline.push tfs.$generate_missing_p_tags()\n    @pipeline.push tfs.$generate_html_nls { mode: 'plain', tid: 'nl', } ### NOTE removes virtual nl, should come late ###\n    @pipeline.push tfs.$convert_escaped_chrs()\n    @pipeline.push tfs.$stamp_borders()\n    # @pipeline.push ( d ) -> urge '^_build_pipeline@5^', rpr d\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  send: ( P... ) -> @pipeline.send P...\n  run:  ( P... ) -> @pipeline.run  P...\n  walk: ( P... ) -> @pipeline.walk P...\n  step: ( P... ) -> @pipeline.step P...\n\n\n#===========================================================================================================\nmodule.exports = { Hypedown_parser, }\n"
  ]
}